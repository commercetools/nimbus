---
id: Home-Testing-Setup
title: Testing Setup
description: Configure Jest or Vitest to test Nimbus components
documentState: InitialDraft
order: 1.6
menu:
  - Home
  - Getting Started
  - Testing Setup
tags:
  - guide
  - testing
  - jest
  - vitest
icon: Science
---

# Testing Setup

Nimbus components require specific polyfills to work in JSDOM test environments (Jest, Vitest). This guide shows you how to configure your test runner to work with Nimbus.

## Why JSDOM Polyfills?

JSDOM is a headless browser environment used by Jest and Vitest. It doesn't include all browser APIs that Chakra UI and React Aria (which Nimbus is built on) depend on. Nimbus provides polyfills for these missing APIs.

The polyfills include:
- `structuredClone` - Required by Chakra UI for theme configuration
- `window.matchMedia` - Required for responsive design and color mode
- `ResizeObserver` - Required for responsive components
- `IntersectionObserver` - Required for lazy loading and viewport tracking
- `Element.prototype.scrollTo/scrollIntoView` - Required for focus management
- `requestAnimationFrame` - Required for animations and transitions

## Jest Setup

### 1. Add Polyfills to Setup Files

Add Nimbus polyfills to your Jest configuration's `setupFiles` array:

```javascript
// jest.config.js
module.exports = {
  setupFiles: [
    '@commercetools/nimbus/setup-jsdom-polyfills'
  ]
};
```

### Complete Example

```javascript
// jest.config.js
module.exports = {
  testEnvironment: 'jsdom',
  setupFiles: [
    // Add Nimbus polyfills BEFORE other setup files
    '@commercetools/nimbus/setup-jsdom-polyfills'
  ],
  setupFilesAfterEnv: [
    '@testing-library/jest-dom',
  ],
  moduleNameMapper: {
    '\\.(css|less|scss|sass)$': 'identity-obj-proxy',
  },
};
```

### 2. Write Tests

With the polyfills configured, you can test Nimbus components:

```typescript
// button.test.tsx
import { render, screen } from '@testing-library/react';
import { NimbusProvider } from '@commercetools/nimbus';
import { Button } from '@commercetools/nimbus';

describe('Button', () => {
  it('renders button text', () => {
    render(
      <NimbusProvider>
        <Button>Click me</Button>
      </NimbusProvider>
    );

    expect(screen.getByRole('button', { name: 'Click me' })).toBeInTheDocument();
  });
});
```

> [!IMPORTANT]
> Always wrap your components in `<NimbusProvider>` when testing, just like in your application.

## Vitest Setup

### 1. Add Polyfills to Setup Files

Add Nimbus polyfills to your Vitest configuration:

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    environment: 'jsdom',
    setupFiles: [
      '@commercetools/nimbus/setup-jsdom-polyfills'
    ],
  },
});
```

### Complete Example

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'jsdom',
    setupFiles: [
      // Add Nimbus polyfills
      '@commercetools/nimbus/setup-jsdom-polyfills',
      // Add other setup files
      './test/setup.ts',
    ],
    globals: true,
  },
});
```

### 2. Write Tests

```typescript
// button.test.tsx
import { render, screen } from '@testing-library/react';
import { describe, it, expect } from 'vitest';
import { NimbusProvider } from '@commercetools/nimbus';
import { Button } from '@commercetools/nimbus';

describe('Button', () => {
  it('renders button text', () => {
    render(
      <NimbusProvider>
        <Button>Click me</Button>
      </NimbusProvider>
    );

    expect(screen.getByRole('button', { name: 'Click me' })).toBeInTheDocument();
  });
});
```

## Testing Best Practices

### Always Use NimbusProvider

Wrap your test components in `NimbusProvider`:

```typescript
// ✅ Correct
render(
  <NimbusProvider>
    <YourComponent />
  </NimbusProvider>
);

// ❌ Incorrect - will cause errors
render(<YourComponent />);
```

### Create a Test Utility

For convenience, create a custom render function:

```typescript
// test-utils.tsx
import { render, RenderOptions } from '@testing-library/react';
import { NimbusProvider } from '@commercetools/nimbus';
import { ReactElement } from 'react';

export function renderWithNimbus(
  ui: ReactElement,
  options?: RenderOptions
) {
  return render(ui, {
    wrapper: ({ children }) => <NimbusProvider>{children}</NimbusProvider>,
    ...options,
  });
}

// Usage in tests
import { renderWithNimbus } from './test-utils';

renderWithNimbus(<Button>Click me</Button>);
```

### Testing Responsive Components

Mock `window.matchMedia` for specific test cases:

```typescript
it('renders mobile layout', () => {
  // Override the polyfill for this specific test
  Object.defineProperty(window, 'matchMedia', {
    writable: true,
    value: (query: string) => ({
      matches: query === '(max-width: 768px)',
      media: query,
      onchange: null,
      addListener: () => {},
      removeListener: () => {},
      addEventListener: () => {},
      removeEventListener: () => {},
      dispatchEvent: () => false,
    }),
  });

  renderWithNimbus(<ResponsiveComponent />);

  expect(screen.getByText('Mobile View')).toBeInTheDocument();
});
```

### Testing Color Mode

Test components in different color modes:

```typescript
import { render, screen } from '@testing-library/react';
import { NimbusProvider } from '@commercetools/nimbus';

it('renders in dark mode', () => {
  render(
    <NimbusProvider colorMode="dark">
      <ThemedComponent />
    </NimbusProvider>
  );

  expect(screen.getByTestId('themed-element')).toHaveStyle({
    backgroundColor: 'rgb(26, 32, 44)', // dark mode bg
  });
});
```

## Troubleshooting

### Error: window.matchMedia is not a function

**Cause**: The Nimbus polyfills aren't loaded, or you're using an older version.

**Solution**:
1. Ensure `@commercetools/nimbus/setup-jsdom-polyfills` is in your `setupFiles`
2. Update Nimbus to v2.3.0 or later: `pnpm add @commercetools/nimbus@latest`

### Error: structuredClone is not defined

**Cause**: The polyfills aren't loaded before Chakra UI initializes.

**Solution**:
1. Ensure polyfills are in `setupFiles` (not `setupFilesAfterEnv`)
2. Place the polyfill import BEFORE other setup files

### Error: Cannot find module '@commercetools/nimbus/setup-jsdom-polyfills'

**Cause**: The module resolution isn't configured correctly.

**Solution**:
```javascript
// jest.config.js
module.exports = {
  moduleDirectories: ['node_modules'],
  setupFiles: [
    '@commercetools/nimbus/setup-jsdom-polyfills'
  ]
};
```

### Tests are slow

**Cause**: JSDOM can be slower than expected for complex components.

**Solution**:
1. Use `renderWithNimbus` wrapper to avoid repetitive NimbusProvider setup
2. Consider using Storybook interaction tests for complex UI testing
3. Mock expensive operations in tests

### TypeScript errors in test files

**Cause**: TypeScript can't find types for test utilities.

**Solution**:
```json
// tsconfig.json
{
  "compilerOptions": {
    "types": ["vitest/globals", "@testing-library/jest-dom"]
  }
}
```

## Advanced Configuration

### Multiple Test Projects

If you have multiple test projects (e.g., unit tests and integration tests):

```javascript
// jest.config.js
module.exports = {
  projects: [
    {
      displayName: 'unit',
      testEnvironment: 'jsdom',
      setupFiles: ['@commercetools/nimbus/setup-jsdom-polyfills'],
      testMatch: ['**/*.test.{ts,tsx}'],
    },
    {
      displayName: 'integration',
      testEnvironment: 'node',
      testMatch: ['**/*.integration.{ts,tsx}'],
    },
  ],
};
```

### Custom Polyfills

If you need additional polyfills beyond what Nimbus provides:

```javascript
// test/setup.js
import '@commercetools/nimbus/setup-jsdom-polyfills';

// Add your custom polyfills
global.IntersectionObserver = class IntersectionObserver {
  // Custom implementation
};
```

## Examples

### Testing a Form Component

```typescript
import { render, screen, userEvent } from '@testing-library/react';
import { NimbusProvider, TextInput, Button, Stack } from '@commercetools/nimbus';

describe('LoginForm', () => {
  it('submits form with user input', async () => {
    const handleSubmit = vi.fn();

    render(
      <NimbusProvider>
        <form onSubmit={handleSubmit}>
          <Stack>
            <TextInput name="email" placeholder="Email" />
            <TextInput name="password" type="password" placeholder="Password" />
            <Button type="submit">Login</Button>
          </Stack>
        </form>
      </NimbusProvider>
    );

    await userEvent.type(screen.getByPlaceholderText('Email'), 'user@example.com');
    await userEvent.type(screen.getByPlaceholderText('Password'), 'password123');
    await userEvent.click(screen.getByRole('button', { name: 'Login' }));

    expect(handleSubmit).toHaveBeenCalled();
  });
});
```

### Testing Accessibility

```typescript
import { render, screen } from '@testing-library/react';
import { axe, toHaveNoViolations } from 'jest-axe';
import { NimbusProvider, Button } from '@commercetools/nimbus';

expect.extend(toHaveNoViolations);

describe('Button accessibility', () => {
  it('has no accessibility violations', async () => {
    const { container } = render(
      <NimbusProvider>
        <Button>Accessible Button</Button>
      </NimbusProvider>
    );

    const results = await axe(container);
    expect(results).toHaveNoViolations();
  });
});
```

## Related Documentation

- [Installation Guide](/home/getting-started/installation) - Initial setup
- [Peer Dependencies](/home/getting-started/peer-dependencies) - Required dependencies
- [Core Concepts](/home/getting-started/core-concepts) - Learn Nimbus fundamentals
