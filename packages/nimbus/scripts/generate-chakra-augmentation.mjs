/**
 * Auto-generates src/types/chakra-augmentation.d.ts from Chakra's typegen output.
 * This ensures the augmentation is always in sync with our actual recipes.
 *
 * How it works:
 * 1. Reads generated-types/recipes.gen.d.ts (output from chakra typegen)
 * 2. Extracts ConfigSlotRecipes and ConfigRecipes interfaces
 * 3. Creates a declaration module that augments @chakra-ui/react
 * 4. Writes to src/types/chakra-augmentation.d.ts
 *
 * This file is automatically included when consumers import Nimbus,
 * making all Nimbus recipe types available without consumer-side typegen.
 */

import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const GENERATED_TYPES_DIR = path.join(__dirname, "../generated-types");
const OUTPUT_FILE = path.join(
  __dirname,
  "../src/types/chakra-augmentation.d.ts"
);

function main() {
  // Ensure generated-types directory exists
  if (!fs.existsSync(GENERATED_TYPES_DIR)) {
    console.error("❌ Error: generated-types directory not found.");
    console.error('   Run "pnpm build-theme-typings" first to generate types.');
    process.exit(1);
  }

  // Read the generated recipes file
  const recipesGenPath = path.join(GENERATED_TYPES_DIR, "recipes.gen.d.ts");
  if (!fs.existsSync(recipesGenPath)) {
    console.error("❌ Error: recipes.gen.d.ts not found in generated-types.");
    console.error('   Run "pnpm build-theme-typings" first to generate types.');
    process.exit(1);
  }

  const recipesContent = fs.readFileSync(recipesGenPath, "utf-8");

  // Parse out the ConfigSlotRecipes interface content
  const slotRecipesMatch = recipesContent.match(
    /export interface ConfigSlotRecipes \{([\s\S]*?)\n\}/
  );

  // Parse out the ConfigRecipes interface content
  const regularRecipesMatch = recipesContent.match(
    /export interface ConfigRecipes \{([\s\S]*?)\n\}/
  );

  if (!slotRecipesMatch && !regularRecipesMatch) {
    console.error(
      "❌ Error: Could not parse recipe interfaces from generated types."
    );
    console.error("   The structure of recipes.gen.d.ts may have changed.");
    process.exit(1);
  }

  // Generate the augmentation file
  const augmentation = `/* eslint-disable */
// @ts-nocheck
/**
 * TypeScript declaration merging to add Nimbus's custom recipes to Chakra's type system.
 *
 * ⚠️  AUTO-GENERATED - DO NOT EDIT MANUALLY
 * Generated by: scripts/generate-chakra-augmentation.mjs
 * Source: generated-types/recipes.gen.d.ts
 *
 * This file augments @chakra-ui/react's ConfigSlotRecipes and ConfigRecipes interfaces
 * with Nimbus-specific recipes so that SlotRecipeProps and RecipeProps lookups work correctly.
 *
 * Without this augmentation, types like \`SlotRecipeProps<"nimbusDrawer">["placement"]\`
 * would resolve to \`never\` (widened to \`any\`), losing all type safety.
 *
 * How it works:
 * - TypeScript's declaration merging allows us to extend third-party module interfaces
 * - When consumers import from @commercetools/nimbus, this augmentation is automatically applied
 * - Chakra's type system now includes all Nimbus recipes
 * - No consumer-side typegen required!
 */

import '@chakra-ui/react';

declare module '@chakra-ui/react' {${
    slotRecipesMatch
      ? `
  interface ConfigSlotRecipes {${slotRecipesMatch[1]}
  }`
      : ""
  }${
    regularRecipesMatch
      ? `

  interface ConfigRecipes {${regularRecipesMatch[1]}
  }`
      : ""
  }
}
`;

  // Ensure the types directory exists
  const typesDir = path.dirname(OUTPUT_FILE);
  if (!fs.existsSync(typesDir)) {
    fs.mkdirSync(typesDir, { recursive: true });
  }

  // Write the augmentation file
  fs.writeFileSync(OUTPUT_FILE, augmentation, "utf-8");

  // Count the recipes for reporting
  const slotRecipeCount = (slotRecipesMatch?.[1].match(/\n\s{2}\w+:/g) || [])
    .length;
  const regularRecipeCount = (
    regularRecipesMatch?.[1].match(/\n\s{2}\w+:/g) || []
  ).length;

  console.log("✅ Generated chakra-augmentation.d.ts");
  console.log(`   - ${slotRecipeCount} slot recipes`);
  console.log(`   - ${regularRecipeCount} regular recipes`);
  console.log(`   → ${OUTPUT_FILE}`);
}

main();
