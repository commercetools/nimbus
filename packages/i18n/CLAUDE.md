# Nimbus Internationalization

## Package Overview

The `@commercetools/nimbus-i18n` package provides:
- Translation messages for all Nimbus components
- Compiled message data for react-intl runtime
- Integration with Transifex for translation management

## Build Process

### Compilation Commands

```bash
# Compile translations from root (recommended)
pnpm --filter @commercetools/nimbus-i18n build

# Or change to package directory
cd packages/i18n
pnpm build

# Or use formatjs CLI directly from root
pnpm dlx @formatjs/cli compile-folder --format=transifex --ast packages/i18n/data packages/i18n/compiled-data
```

### What Compilation Does

Compiles JSON messages from `data/` into optimized AST format in `compiled-data/` for runtime usage. This:
- Reduces bundle size
- Improves runtime performance
- Provides type-safe message access

## Directory Structure

```
packages/i18n/
├── data/              # Source translation files (JSON)
│   ├── core.json      # Nimbus component messages (English source)
│   ├── de.json        # German translations
│   ├── es.json        # Spanish translations
│   ├── fr.json        # French translations
│   └── ...            # Additional locales
├── compiled-data/     # Compiled for react-intl (generated by build)
│   ├── core.json
│   ├── de.json
│   └── ...
├── package.json
└── README.md
```

## Translation Workflow

### 1. Message Extraction

Extract messages from components (run from repo root):

```bash
pnpm extract-intl
```

This command:
1. Scans all `.i18n.ts` files in packages and components
2. Extracts messages using `@formatjs/cli`
3. Outputs to `packages/i18n/data/core.json`
4. Automatically compiles translations

### 2. Message Definition

Define messages in component `.i18n.ts` files:

```typescript
// packages/nimbus/src/components/button/button.i18n.ts
import { defineMessages } from 'react-intl'

export const buttonMessages = defineMessages({
  loading: {
    id: 'nimbus.button.loading',
    defaultMessage: 'Loading...',
    description: 'Button loading state text for screen readers'
  },
  submit: {
    id: 'nimbus.button.submit',
    defaultMessage: 'Submit',
    description: 'Default submit button label'
  }
})
```

### 3. Transifex Integration

1. Messages are pushed to Transifex for translation
2. Translators provide translations for all supported locales
3. Translations are pulled back to `data/[locale].json`
4. Compile translations for runtime use: `pnpm --filter @commercetools/nimbus-i18n build`

### 4. Usage in Components

```typescript
// In a component file
import { useIntl } from 'react-intl'
import { buttonMessages } from './button.i18n'

function Button() {
  const intl = useIntl()
  const loadingLabel = intl.formatMessage(buttonMessages.loading)

  return <button aria-label={loadingLabel}>Click me</button>
}
```

## Message ID Convention

Use namespaced IDs following this pattern:

```
nimbus.{component}.{key}
```

Examples:
- `nimbus.button.loading` - Button loading state
- `nimbus.datepicker.selectDate` - Date picker label
- `nimbus.menu.close` - Menu close button
- `nimbus.pagination.nextPage` - Pagination next button

**Guidelines:**
- Always start with `nimbus.`
- Use component name in singular form
- Use descriptive keys that indicate purpose
- Keep keys concise but meaningful

## Adding New Messages

1. **Define message in component's `.i18n.ts` file**
   ```typescript
   export const myComponentMessages = defineMessages({
     newKey: {
       id: 'nimbus.myComponent.newKey',
       defaultMessage: 'New message text',
       description: 'Explanation for translators'
     }
   })
   ```

2. **Extract messages from root**
   ```bash
   pnpm extract-intl
   ```

3. **Verify extraction in `packages/i18n/data/core.json`**
   - Check that your new message appears
   - Verify ID, defaultMessage, and description

4. **Compile translations**
   ```bash
   pnpm --filter @commercetools/nimbus-i18n build
   ```

5. **Use in component**
   ```typescript
   const message = intl.formatMessage(myComponentMessages.newKey)
   ```

## Supported Locales

Check `data/` directory for available locale files:
- `core.json` - Source messages (English)
- `de.json` - German (Deutsch)
- `es.json` - Spanish (Español)
- `fr.json` - French (Français)

To add a new locale:
1. Create `data/[locale].json` file
2. Add translations for all message IDs
3. Run build to compile

## Build Dependencies

This package:
- Has minimal dependencies (formatjs, react-intl)
- Does not depend on other nimbus packages
- Can build independently
- Is consumed by nimbus as a peer dependency

## Testing Translations

When testing components with translations:

```typescript
// In test files
import { IntlProvider } from 'react-intl'
import messages from '@commercetools/nimbus-i18n/compiled-data/core.json'

// Wrap component with IntlProvider
<IntlProvider locale="en" messages={messages}>
  <YourComponent />
</IntlProvider>
```

For Storybook stories:
```typescript
// Stories automatically wrap with IntlProvider
// Just use messages normally in components
export const Primary: Story = {
  render: () => <Button>Submit</Button>
}
```

## Common Tasks

### Update Existing Translation

1. Edit `data/core.json` (for English source)
2. Update the `defaultMessage` value
3. Run `pnpm --filter @commercetools/nimbus-i18n build`
4. For other locales, update in `data/[locale].json`

### Find All Messages for a Component

```bash
# Search in data/core.json
grep "nimbus.button" packages/i18n/data/core.json
```

### Debug Missing Translations

If translations aren't working:
1. Check `.i18n.ts` file exists and messages are defined
2. Run `pnpm extract-intl` to ensure extraction
3. Verify message appears in `data/core.json`
4. Run build to compile: `pnpm --filter @commercetools/nimbus-i18n build`
5. Check component imports and uses `intl.formatMessage` correctly
