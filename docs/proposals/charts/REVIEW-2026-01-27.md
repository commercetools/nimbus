# Charting Proposals Review

> **Date**: 2026-01-27 **Reviewer**: Claude **Status**: Review Complete
> **Documents Reviewed**: 00-foundation.md through 06-funnel-chart.md

---

## Executive Summary

The charting proposals are well-architected with solid technical foundations
(Visx, token integration, accessibility-first approach). However, there are
several consistency issues and a critical ARIA bug that should be addressed
before implementation begins.

**Verdict**: Ready for implementation after addressing Critical and High
priority items.

---

## Critical Issues

These must be fixed before implementation starts.

### 1. Invalid ARIA Structure (All Charts)

**Location**: All chart proposals (Line, Bar, Area, Pie, Funnel)

**Current Implementation**:

```tsx
<div role="img" aria-label="...">
  <svg role="presentation">
    {items.map((item) => (
      <element role="listitem" />
    ))}
  </svg>
</div>
```

**Problem**: `role="img"` cannot have child elements with semantic roles. The
`img` role expects the element to be perceived as a single image with no
interactive children. This is invalid ARIA and will cause accessibility audit
failures.

**Recommended Fix**:

```tsx
<div role="figure" aria-labelledby={labelId}>
  <div id={labelId} className="visually-hidden">
    Chart description
  </div>
  <svg role="presentation">
    <g role="list">
      {items.map((item) => (
        <element role="listitem" />
      ))}
    </g>
  </svg>
</div>
```

**Impact**: WCAG compliance failure, screen reader confusion.

---

### 2. Bar Chart Uses Tab for Internal Navigation

**Location**: `03-bar-chart.md` line 368

**Current Specification**:

> `Tab` - Move focus between series within same category (grouped)

**Problem**: This violates WCAG keyboard navigation patterns. Tab should move
OUT of the component to the next focusable element on the page, not navigate
within the component. Using Tab for intra-component navigation breaks user
expectations built from every other web application.

**Recommended Fix**: Use arrow keys for all internal navigation:

| Key       | Action                                        |
| --------- | --------------------------------------------- |
| `←` / `→` | Move between categories                       |
| `↑` / `↓` | Move between series within category (grouped) |
| `Home`    | First bar                                     |
| `End`     | Last bar                                      |

**Impact**: WCAG 2.1.1 failure, user confusion.

---

### 3. Legend Interaction Model Inconsistency

**Location**: Cross-cutting across all proposals

**Current Behavior**:

| Chart  | Legend Click Behavior           |
| ------ | ------------------------------- |
| Line   | HIDE/SHOW series (toggle)       |
| Bar    | HIDE/SHOW series (toggle)       |
| Area   | HIDE/SHOW series (toggle)       |
| Pie    | HIGHLIGHT (dim others, no hide) |
| Funnel | No legend                       |

**Problem**: The same UI pattern (clicking a legend item) does completely
different things depending on chart type. Teams building dashboards with
multiple chart types will create inconsistent user experiences.

**Recommended Fix**: Choose one of:

**Option A**: Standardize on toggle (hide/show) for all charts

- Pie would need to handle "hiding" a segment (show gap or redistribute?)
- Most analytics tools use this pattern

**Option B**: Add explicit prop to control behavior

```typescript
legendInteraction?: "toggle" | "highlight";  // default varies by chart
```

**Option C**: Document as intentional (least preferred)

- Clearly explain in each proposal why the behavior differs
- Add to main plan as a "behavioral differences" section

**Impact**: User confusion, inconsistent dashboard UX.

---

### 4. Seven-Color Limit With No Overflow Strategy

**Location**: `00-foundation.md` lines 25-36

**Current Specification**: 7 categorical colors based on Miller's Law (7±2).

**Problem**: Real analytics dashboards often exceed 7 series. The proposal
doesn't specify what happens when a consumer passes 8+ categories.

**Recommended Fix**: Specify in Foundation one of:

```typescript
// Option A: Cycle colors (document behavior)
const getColor = (index: number) => `chart.${(index % 7) + 1}`;

// Option B: Dev warning + cycle
if (categories.length > 7 && process.env.NODE_ENV === "development") {
  console.warn(
    `[nimbus-charts] ${categories.length} series exceeds recommended maximum of 7. ` +
      `Colors will cycle. Consider using fewer series or custom colors in config.`
  );
}

// Option C: Document config override as escape hatch
config={{
  series8: { label: "Series 8", color: "purple.9" },  // Custom color
}}
```

**Impact**: Runtime confusion, poor defaults for common use case.

---

## High Priority Issues

Should be addressed during Foundation implementation or early chart development.

### 5. KPI Card Recipe/Prop Mismatch

**Location**: `01-kpi-card.md` lines 116-163

**Problem**: The recipe defines `sentiment` as a variant on the slot recipe, but
`sentiment` is a prop on `KpiCard.Trend`, not on `KpiCard.Root`.

```typescript
// Recipe defines:
variants: {
  sentiment: {
    positive: { trend: { color: "positive.11" } },
    negative: { trend: { color: "critical.11" } },
    neutral: { trend: { color: "neutral.11" } },
  }
}

// But API defines:
<KpiCard.Root variant="default">        {/* No sentiment here */}
  <KpiCard.Trend sentiment="positive">  {/* Sentiment is here */}
```

**Question**: How does the Trend component's `sentiment` prop apply the recipe
variant? Slot recipes typically derive variants from the Root component's props.

**Recommended Fix**: Clarify the implementation approach:

```typescript
// Option A: Use context to pass sentiment to recipe
const KpiCardTrend = ({ sentiment, children }) => {
  const { setTrendSentiment } = useKpiCardContext();
  useEffect(() => setTrendSentiment(sentiment), [sentiment]);
  // ...
};

// Option B: Apply styles directly in component, not via recipe variant
const KpiCardTrend = ({ sentiment, children }) => {
  const sentimentColors = {
    positive: "positive.11",
    negative: "critical.11",
    neutral: "neutral.11",
  };
  return <Box color={sentimentColors[sentiment]}>{children}</Box>;
};
```

---

### 6. X-Axis Type Auto-Detection Unspecified

**Location**: `02-line-chart.md` line 28

**Current Specification**:

> `xAxisType?: "category" | "time"; // auto-detected if omitted`

**Problem**: No algorithm specified. Will `"2024-01-15"` become time or
category? What about Date objects vs ISO strings vs Unix timestamps?

**Recommended Fix**: Add to Foundation or Line Chart proposal:

```typescript
/**
 * Auto-detection algorithm for xAxisType:
 * 1. Sample first non-null value from data[index]
 * 2. If value is Date instance → "time"
 * 3. If value is number AND > 1_000_000_000 (Unix timestamp threshold) → "time"
 * 4. If value is string AND matches ISO 8601 pattern → "time"
 * 5. Otherwise → "category"
 *
 * Recommendation: Always specify xAxisType explicitly for predictable behavior.
 */
```

---

### 7. No Controlled Mode for Hidden Series

**Location**: All chart proposals with legend toggle

**Current State**: Internal state only via `hiddenSeries: Set<string>` in
context.

**Problem**: Teams wanting to persist legend toggle state across page loads or
sync across multiple charts have no way to control this state.

**Recommended Fix**: Add to `BaseChartProps`:

```typescript
interface BaseChartProps<T> {
  // ... existing props

  /** Controlled: which series are hidden */
  hiddenSeries?: string[];

  /** Callback when hidden series changes (enables controlled mode) */
  onHiddenSeriesChange?: (hiddenSeries: string[]) => void;
}
```

Implementation uses standard controlled/uncontrolled pattern:

```typescript
const [internalHidden, setInternalHidden] = useState<Set<string>>(new Set());
const isControlled = hiddenSeries !== undefined;
const hidden = isControlled ? new Set(hiddenSeries) : internalHidden;

const toggleSeries = (key: string) => {
  const next = new Set(hidden);
  next.has(key) ? next.delete(key) : next.add(key);

  if (isControlled) {
    onHiddenSeriesChange?.([...next]);
  } else {
    setInternalHidden(next);
  }
};
```

---

### 8. KPI Card i18n Doesn't Cover Direction + Sentiment Combinations

**Location**: `01-kpi-card.md` lines 173-186

**Current Messages**:

- `trendIncreasedBy` → used for direction="up"
- `trendDecreasedBy` → used for direction="down"
- `trendUnchangedAt` → used for direction="unchanged"

**Problem**: Direction and sentiment are independent. If direction="up" +
sentiment="negative" (e.g., bounce rate increased = bad), the screen reader
announces "increased by" but the visual shows red/critical styling.

This semantic mismatch confuses assistive technology users.

**Recommended Fix**: Either add combined messages or restructure the
announcement:

```typescript
// Option A: Combined messages
trendIncreasedPositive: {
  id: "nimbus-charts.kpi-card.trend-increased-positive",
  defaultMessage: "increased by {value}, positive change",
},
trendIncreasedNegative: {
  id: "nimbus-charts.kpi-card.trend-increased-negative",
  defaultMessage: "increased by {value}, negative change",
},

// Option B: Separate sentiment announcement
// "Bounce rate: +12.5% (increased). This change is negative."
trendDirection: {
  id: "nimbus-charts.kpi-card.trend-direction",
  defaultMessage: "{direction} by {value}",
},
trendSentiment: {
  id: "nimbus-charts.kpi-card.trend-sentiment",
  defaultMessage: "This change is {sentiment}",
},
```

---

## Medium Priority Issues

Should be documented or addressed during implementation.

### 9. Data Shape Divergence

**Location**: Cross-cutting

| Charts        | Data Props             |
| ------------- | ---------------------- |
| Line/Bar/Area | `index` + `categories` |
| Pie/Funnel    | `dataKey` + `nameKey`  |

**Problem**: Teams can't create a generic chart wrapper or easily switch chart
types without refactoring the data layer.

**Assessment**: This is arguably correct—time-series data (Line/Bar/Area) is
fundamentally different from categorical data (Pie/Funnel). However, it should
be explicitly documented as an intentional design decision.

**Recommended Action**: Add to main plan a "Data Shape Patterns" section
explaining the rationale.

---

### 10. Malformed Markdown Tables

**Location**: `03-bar-chart.md` lines 88-97, `05-pie-chart.md` lines 95-101

**Problem**: Union types inside table cells break markdown rendering:

```markdown
| `Legend` | Clickable legend with
`position: "top" | "bottom" | "left" | "right"` |
```

**Fix**: Escape or restructure:

```markdown
| `Legend` | Clickable legend with `position` prop. Options: top, bottom, left,
right |
```

---

### 11. Inconsistent File Naming

**Location**: File structure sections across proposals

| Chart      | MDX File               |
| ---------- | ---------------------- |
| KPI Card   | `kpi-card.dev.mdx`     |
| Line Chart | `line-chart.mdx`       |
| Bar Chart  | `bar-chart.dev.mdx`    |
| Area Chart | `area-chart.dev.mdx`   |
| Pie Chart  | `pie-chart.dev.mdx`    |
| Funnel     | `funnel-chart.dev.mdx` |

**Fix**: Line Chart should be `line-chart.dev.mdx` to match Nimbus patterns.

---

### 12. Tooltip Slot Naming Divergence

**Location**: Recipe definitions across proposals

| Chart | Header Slot     |
| ----- | --------------- |
| Line  | `tooltipLabel`  |
| Bar   | `tooltipHeader` |
| Area  | `tooltipLabel`  |
| Pie   | `tooltipLabel`  |

**Fix**: Standardize on `tooltipHeader` or `tooltipLabel` across all charts.

---

### 13. Dual Y-Axis Reasoning Inconsistency

**Location**: `02-line-chart.md` vs `04-area-chart.md`

- Line Chart: Supports dual Y-axis via compound API
- Area Chart: Explicitly doesn't ("stacking makes dual Y-axis confusing")

**Problem**: Line Chart also supports stacking. The reasoning isn't applied
consistently.

**Recommended Action**: Either:

1. Area Chart should support dual Y-axis for overlapping layout only
2. Document that dual Y-axis is intentionally Line Chart-specific

---

### 14. Funnel Chart Minimum Width Missing

**Location**: `06-funnel-chart.md`

**Problem**: If the last funnel stage is 1% conversion, the trapezoid could be
nearly invisible.

**Recommended Fix**:

```typescript
interface FunnelChartProps {
  /** Minimum stage width as percentage (0-1). Default: 0.05 (5%) */
  minStageWidth?: number;
}
```

---

### 15. Percentage Formatting Responsibility Unclear

**Location**: Foundation + all chart i18n

**Problem**: Foundation eliminated `useChartFormatters` saying "consumer
responsibility via `valueFormatter`". But i18n messages use `{percentage}`
placeholders. Who formats these percentages?

**Question**: Does `valueFormatter` receive:

- Raw values only? (Then who formats percentages?)
- Both values and computed percentages?

**Recommended Fix**: Add to Foundation:

```typescript
interface BaseChartProps<T> {
  /** Format raw values (e.g., revenue numbers) */
  valueFormatter?: (value: number) => string;

  /** Format percentages (default: `${(n * 100).toFixed(0)}%`) */
  percentageFormatter?: (ratio: number) => string;
}
```

---

## Minor Issues

### 16. Recipe Import Inconsistency

- KPI Card uses `defineSlotRecipe`
- Others use `sva` from `@chakra-ui/react`

Verify these are equivalent or standardize.

### 17. Gradient ID Collision Risk

Area Chart says "unique IDs generated in Root" but no algorithm specified.

**Fix**: Use `useId()` from React 18:

```typescript
const gradientId = useId();
// Results in: nimbus-area-gradient-:r1:
```

### 18. "Show as Table" Is Deferred

Line Chart Key Decisions mentions "Show as table: Deferred" but this is a WCAG
accessibility feature for data tables. Should clarify timeline (Phase 2?).

### 19. Performance Guidance Missing

No documentation on data limits or performance characteristics.

**Recommended Addition to Foundation**:

```markdown
## Performance Considerations

- Recommended maximum data points: 500 per series
- For larger datasets, consider:
  - Data sampling/aggregation before passing to chart
  - Using `useMemo` for data transformations
- SVG rendering is not virtualized; very large datasets will impact performance
```

### 20. TypeScript Can't Catch Config Key Mismatches

```tsx
categories={["revenue"]}
config={{ revenu: { ... } }}  // Typo - no TS error
```

**Potential Fix** (complex, may defer):

```typescript
type ChartConfig<T extends string> = {
  [K in T]: {
    label: string;
    color: string;
    icon?: React.ComponentType;
  };
};

interface BaseChartProps<T, C extends string> {
  categories: C[];
  config: ChartConfig<C>;
}
```

---

## Summary Scorecard

| Aspect          | Rating          | Notes                                      |
| --------------- | --------------- | ------------------------------------------ |
| Architecture    | ✅ Good         | Solid Visx foundation, good token design   |
| API Consistency | ⚠️ Needs Work   | Data shapes and interactions vary          |
| Accessibility   | ❌ Critical Bug | ARIA structure invalid, Tab misuse         |
| Type Safety     | ⚠️ Acceptable   | Config keys not enforced                   |
| i18n            | ⚠️ Needs Work   | Percentage formatting, direction+sentiment |
| Documentation   | ✅ Good         | Thorough, minor formatting issues          |
| Scalability     | ⚠️ Acceptable   | Missing overflow/perf guidance             |

---

## Recommended Action Items

### Before Implementation Starts

- [ ] Fix ARIA structure pattern in Foundation (use `role="figure"` or
      `role="group"`)
- [ ] Remove Tab navigation from Bar Chart keyboard spec
- [ ] Decide on legend interaction model (add to main plan)
- [ ] Specify 7+ color overflow behavior in Foundation

### During Foundation Implementation

- [ ] Clarify KPI Card recipe/prop relationship
- [ ] Document x-axis type auto-detection algorithm
- [ ] Add controlled `hiddenSeries` props to `BaseChartProps`
- [ ] Add `percentageFormatter` to `BaseChartProps`

### During First Chart Implementation

- [ ] Fix malformed markdown tables
- [ ] Standardize file naming (`.dev.mdx`)
- [ ] Standardize tooltip slot names
- [ ] Add performance guidance section

---

## Appendix: Affected Lines by File

| File                 | Lines to Review                              |
| -------------------- | -------------------------------------------- |
| `00-foundation.md`   | 25-36 (colors), 183-217 (useChartA11y)       |
| `01-kpi-card.md`     | 116-163 (recipe), 173-186 (i18n)             |
| `02-line-chart.md`   | 28 (xAxisType), 228-230 (ARIA)               |
| `03-bar-chart.md`    | 88-97 (table), 368 (Tab nav), 406-437 (ARIA) |
| `04-area-chart.md`   | 408-442 (ARIA), 767 (dual Y-axis)            |
| `05-pie-chart.md`    | 95-101 (table), 340-366 (ARIA)               |
| `06-funnel-chart.md` | 370-396 (ARIA), 701 (min width)              |
